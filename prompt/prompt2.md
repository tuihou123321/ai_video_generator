### **第二阶段：生成动态渲染的页面**

**目标：** 根据用户输入的短视频逐字稿、声音和主角角色图，动态调用API生成视频声音、字幕文件和配图，并最终生成一个完整、功能齐全的HTML网页。

**用户界面配置：**

-   **短视频逐字稿：** 多行文本输入框。
    -   默认测试值：“听好了，从今儿起，别再把自己当软柿子捏。学着用狠角色的路子火。”
-   **声音选择：** 下拉选择框。
    -   选项：通过联网搜索“qwen3-tts-flash”支持的声音。
    -   默认值：“Ethan”
-   **图生图主角角色图：** 文本输入框。
    -   默认值：“[https://cdnv2.ruguoapp.com/Fqrfh4Ix879kG9SgXtm9R9zk-uTiv3.png?imageMogr2/auto-orient/thumbnail/400x2000%3E](https://cdnv2.ruguoapp.com/Fqrfh4Ix879kG9SgXtm9R9zk-uTiv3.png?imageMogr2/auto-orient/thumbnail/400x2000%3E)”

**核心逻辑与数据流：**

这个过程需要按照以下**严格的顺序**执行：

#### **1. 文本转语音（生成音频文件）**

1.  **输入：**
    -   从“短视频逐字稿”输入框获取文本内容。
    -   从“声音选择”下拉框获取选定的声音。
2.  **调用接口：** 使用提供的**通义千问文本转语音API**，将用户提供的文本和声音作为`input.text`和`input.voice`入参。
3.  **输出：** 成功调用后，从API返回的JSON中提取 **`output.audio.url`**。此URL将作为后续步骤的音频源。

#### **2. 音频转字幕（生成字幕文件）**

1.  **输入：** 步骤1中生成的视频声音URL。
2.  **调用接口（两步）：**
    -   **第一步：** 调用**音频生成字幕API**，将视频声音URL作为`input.file_urls`的入参。
    -   **第二步：** 循环调用**查询任务状态API**，传入第一步返回的`task_id`，直到 `task_status` 变为 `SUCCEEDED`。
3.  **输出：** 当任务成功后，从API返回的JSON中提取 **`output.results[0].transcription_url`**。此URL指向包含逐字稿和时间戳的JSON文件。

#### **3. 字幕切分与配图生成**

这是最复杂的步骤，需要对上一步的输出进行处理，并动态生成配图。

1.  **解析字幕文件：**
    -   获取步骤2生成的字幕文件内容，该文件格式已在提供的信息中。
    -   核心数据是 `transcripts[0].words` 数组，它包含了每个字的精确时间戳（`begin_time`和`end_time`）。
2.  **字幕切分规则：**
    -   遍历 `words` 数组，根据 `punctuation` 字段来判断句子的结束，如`,`或`。`。
    -   当遇到标点符号时，将从上一个配图切分点到当前标点符号前的所有文字组合成一段完整的字幕。
    -   **例外处理：** 如果两个标点符号之间的文字过长（例如超过15个汉字），考虑将其进一步切分，以保证配图和字幕的对应关系更紧密。
    -   将切分后的每一小段字幕文本、其对应的开始时间（`words[0].begin_time`）和结束时间（`words[n].end_time`）存储在一个数组中。
3.  **配图生成逻辑：**
    -   **触发时机：** 遍历上一步切分好的每一小段字幕，对每一段调用一次图生图接口。
    -   **调用接口：** 使用**图生图API**。
        -   `image`参数：使用“图生图主角角色图”输入框的URL。
        -   `text`参数（`prompt`）：需要根据当前小段字幕的内容智能生成。例如：
            -   如果字幕是“别再把自己当软柿子捏”，`prompt`可以生成：“一个极简的扁平矢量插画，描绘一只可爱的白色猫咪，它手持一把大锤，锤子指向一个被压扁的柿子。透明背景，png。”
            -   如果字幕是“学着用狠角色的路子火”，`prompt`可以生成：“一个极简的扁平矢量插画，描绘一只可爱的白色猫咪，它手持一把青色步枪，枪口冒着烟，猫咪神情坚毅。透明背景，png。”
4.  **输出：** 将生成的配图URL和其对应的字幕文本、开始时间（`start_time`）存储在一个新的数据结构中。

#### **最终页面集成：**

1.  **HTML页面构建：** 生成一个完整的HTML文件，包含HTML、CSS和JavaScript。
2.  **动态数据渲染：**
    -   使用步骤1生成的**视频声音URL**作为`<audio>`标签的`src`。
    -   使用步骤3生成的**字幕**和**配图**数据，通过JavaScript控制它们的显示、隐藏和动画效果。
